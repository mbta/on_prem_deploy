---

- name: Ensure AudioScience PPA is present
  ansible.builtin.apt_repository:
    repo: "ppa:audioscience/release"

- name: Ensure AudioScience drivers are installed
  ansible.builtin.apt:
    name:
      - asihpi-dkms-4

- name: Install SSM Agent
  community.general.snap:
    name:
      - amazon-ssm-agent

- name: Check SSM registration
  ansible.builtin.stat:
    path: /var/lib/amazon/ssm/registration
  register: ssm_registration

- name: Stop SSM Agent
  ansible.builtin.systemd_service:
    name: snap.amazon-ssm-agent.amazon-ssm-agent.service
    state: stopped
  when: not ssm_registration.stat.exists

- name: Register SSM Agent
  ansible.builtin.command:
    cmd: >-
      /snap/amazon-ssm-agent/current/amazon-ssm-agent -register
      -code {{ lookup('file', '/root/activation-code') }}
      -id {{ lookup('file', '/root/activation-id') }}
      -region us-east-1
  changed_when: true
  when: not ssm_registration.stat.exists

- name: Start SSM Agent
  ansible.builtin.systemd_service:
    name: snap.amazon-ssm-agent.amazon-ssm-agent.service
    state: started
  when: not ssm_registration.stat.exists
