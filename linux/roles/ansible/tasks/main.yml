---

- name: Ensure Ansible PPA is present
  register: onprem_ansible_ppa
  ansible.builtin.apt_repository:
    repo: "ppa:ansible/ansible"
    update_cache: true
    # matches what's generated from cloud-init/user-data
    filename: "ansible-ubuntu-ansible-jammy"

- name: Ensure packages are present
  ansible.builtin.apt:
    name:
      - git
      - ansible
      - python3-pip

- name: Install SSM Agent
  community.general.snap:
    name: amazon-ssm-agent
    classic: true

- name: Register SSM Agent
  ansible.builtin.command:
    cmd: >-
      /snap/amazon-ssm-agent/current/amazon-ssm-agent -register
      -code {{ lookup('file', '/root/activation-code') }}
      -id {{ lookup('file', '/root/activation-id') }}
      -region us-east-1
  changed_when: true
  when: not ssm_registration.stat.exists

- name: Check SSM registration
  ansible.builtin.stat:
    path: /var/lib/amazon/ssm/registration
  register: ssm_registration

- name: Stop SSM Agent
  ansible.builtin.systemd_service:
    name: snap.amazon-ssm-agent.amazon-ssm-agent.service
    state: stopped
  when: not ssm_registration.stat.exists


- name: Start SSM Agent
  ansible.builtin.systemd_service:
    name: snap.amazon-ssm-agent.amazon-ssm-agent.service
    enabled: true
    state: started

- name: Ensure collections directory exists
  ansible.builtin.file:
    path: /root/collections
    state: directory
    mode: "0700"

- name: Copy requirements file
  register: onprem_ansible_requirements
  ansible.builtin.copy:
    src: collections/requirements.yml
    dest: /root/collections/requirements.yml
    mode: "0600"

# required by amazon.aws collection
- name: Ensure boto3 package is installed
  ansible.builtin.pip:
    name: boto3

- name: Install Ansible dependencies
  community.general.ansible_galaxy_install:
    type: collection
    requirements_file: /root/collections/requirements.yml
  when: onprem_ansible_requirements.changed  # noqa: no-handler

- name: Check for local Ansible Vault password
  delegate_to: localhost
  become: false
  ansible.builtin.stat:
    path: .ansible_vault_password
  register: local_ansible_vault_password

- name: Write Ansible Vault password
  when: local_ansible_vault_password.stat.exists
  ansible.builtin.copy:
    src: .ansible_vault_password
    dest: /root/.ansible_vault_password
    mode: "0600"
