#cloud-config

packages:
- git
package_update: true
package_upgrade: true

no_ssh_fingerprints: true
ssh:
  emit_keys_to_console: false

# Provide a key for the default Ubuntu user as a failsafe. Ansible will delete it once the other users are set up.
users:
  - name: ubuntu
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOV3T6Da+IyAFLcND2qAeuTdtrKUUJCL2zaastUNQ5je

write_files:
  - path: /root/.ansible_vault_password
    mode: '0400'
    content: "ANSIBLE_VAULT_PASSWORD"

# Remove userdata from VMware
redact:
- userdata

ansible:
  package_name: ansible
  install_method: distro
  run_user: root
  pull:
    url: "https://github.com/GITHUB_REPO.git"
    checkout: GIT_BRANCH
    extra_vars: "github_repo=GITHUB_REPO git_branch=GIT_BRANCH"
    playbook_name: linux/main.yml
    inventory: linux/inventory.yml
    vault_password_file: /root/.ansible_vault_password
