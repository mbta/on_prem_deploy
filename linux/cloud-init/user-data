#cloud-config

packages:
- git
package_update: true
package_upgrade: true
package_reboot_if_required: true

ssh:
  emit_keys_to_console: false

# By not including `- default` here, we don't create the `ubuntu` admin user.
# By include a user here, we create a login even if Ansible fails to run.
# We use a direct key to avoid hitting GitHub rate limits in CI. -ps
users:
  - name: pswartz
    groups:
      - admin
      - users
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOV3T6Da+IyAFLcND2qAeuTdtrKUUJCL2zaastUNQ5je

write_files:
  - path: /root/.ansible_vault_password
    mode: '0400'
    content: "ANSIBLE_VAULT_PASSWORD"
  - path: /etc/sudoers.d/mbta-admin
    mode: '0600'
    content: "%admin ALL=(ALL) NOPASSWD:ALL"

# Remove userdata from VMware
redact:
- userdata

ansible:
  package_name: ansible
  install_method: distro
  run_user: root
  pull:
    url: "https://github.com/GITHUB_REPO.git"
    checkout: GIT_BRANCH
    extra_vars: "github_repo=GITHUB_REPO git_branch=GIT_BRANCH"
    playbook_name: linux/main.yml
    inventory: linux/inventory.yml
    vault_password_file: /root/.ansible_vault_password
