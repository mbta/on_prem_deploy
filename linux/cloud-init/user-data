#cloud-config

packages:
- git
- ansible
package_update: true
package_upgrade: true

no_ssh_fingerprints: true
ssh:
  emit_keys_to_console: false

# Provide a key for the default Ubuntu user as a failsafe. Ansible will delete it once the other users are set up.
users:
  - name: ubuntu
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOV3T6Da+IyAFLcND2qAeuTdtrKUUJCL2zaastUNQ5je

write_files:
  - path: /root/.ansible_vault_password
    permissions: '0400'
    content: "ANSIBLE_VAULT_PASSWORD"

# Remove userdata from VMware
redact:
- userdata

runcmd:
 - ["ansible-pull",
    "--vault-password-file", "/root/.ansible_vault_password",
    "-e", "github_repo=GITHUB_REPO git_branch=GIT_BRANCH",
    "-i", "linux/inventory.yml",
    "-U", "https://github.com/GITHUB_REPO.git",
    "-C", "GIT_BRANCH",
    "linux/main.yml"]
